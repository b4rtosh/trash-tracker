name: DAST Security Scans

on:
  # RÄ™czne uruchamianie
  workflow_dispatch:
    inputs:
      target_url:
        description: "Target URL to scan"
        required: true
        default: "https://trash-tracker.pl/"

env:
  TARGET_URL: ${{ github.event.inputs.target_url || 'https://trash-tracker.pl/' }}
jobs:
  dast-scans:
    runs-on: ubuntu-latest
    name: Run DAST Scans
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # -------------------------------
      # WAPITI
      # -------------------------------
      - name: Install Wapiti
        run: sudo apt update && sudo apt install -y wapiti

      - name: Run Wapiti scan
        run: |
          wapiti -u "${{ env.TARGET_URL }}" -f html -o wapiti-report.html
        continue-on-error: true

      # -------------------------------
      # SQLMAP
      # -------------------------------
      - name: Install SQLMap
        run: sudo apt install -y sqlmap

      - name: Run SQLMap (safe mode)
        run: |
          sqlmap -u "${{ env.TARGET_URL }}" \
            --batch --crawl=2 --level=2 --risk=1 \
            --dbs --forms --output-dir=sqlmap_output
        continue-on-error: true

      # -------------------------------
      # ZAP (baseline scan)
      # -------------------------------
      - name: ZAP Scan
        uses: zaproxy/action-baseline@v0.6.1
        with:
          target: ${{ env.TARGET_URL }}
          docker_name: ghcr.io/zaproxy/zaproxy:stable
          cmd_options: '-a'
          allow_issue_writing: false
          upload-artifact: false

      - name: Display All DAST Results
        run: |
          echo "==============================="
          echo "        WAPITI REPORT"
          echo "==============================="
          if [ -f wapiti-report.html ]; then
              cat wapiti-report.html
          else
              echo "Wapiti report not found"
          fi
  
          echo ""
          echo "==============================="
          echo "        SQLMAP REPORTS"
          echo "==============================="
          if [ -d sqlmap_output ]; then
              find sqlmap_output -type f -print -exec cat {} \;
          else
              echo "SQLMap output directory not found"
          fi
  
          echo ""
          echo "==============================="
          echo "        ZAP REPORT"
          echo "==============================="
          if [ -f report.html ]; then
              cat report.html
          else
              echo "ZAP report not found"
          fi
  

      # -------------------------------
      # Upload artifacts
      # -------------------------------
      - name: Upload DAST reports
        uses: actions/upload-artifact@v4
        with:
          name: dast-reports
          path: |
            wapiti-report.html
            sqlmap_output/**
            report.html

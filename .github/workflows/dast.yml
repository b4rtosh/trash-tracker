name: DAST Security Scans

on:
  # --- rÄ™czne uruchamianie ---
  workflow_dispatch:
    inputs:
      target_url:
        description: "Target URL to scan"
        required: true
        default: "https://trash-tracker.pl/"

  # --- automatyczne uruchamianie na push/PR ---
  pull_request:
    branches: [ "dast-scan-feature" ]
  push:
    branches: [ "dast-scan-feature" ]

env:
  TARGET_URL: ${{ github.event.inputs.target_url || 'https://trash-tracker.pl/' }}

jobs:
  dast-scans:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # --------------------------------------
      # OWASP ZAP
      # --------------------------------------
      - name: Run ZAP Baseline Scan
        run: |
          mkdir -p /tmp/zap
          docker run \
            -v /tmp/zap:/zap/wrk \
            --network=host \
            ghcr.io/zaproxy/zaproxy:stable \
            zap-baseline.py \
              -t https://trash-tracker.pl/ \
              -J report_json.json \
              -w report_md.md \
              -r report_html.html
      

      # --------------------------------------
      # WAPITI
      # --------------------------------------
      - name: Install Wapiti
        run: sudo apt update && sudo apt install -y wapiti

      - name: Run Wapiti scan
        run: |
          wapiti -u "${{ env.TARGET_URL }}" \
            -f html -o wapiti-report.html
        continue-on-error: true

      # --------------------------------------
      # SQLMAP
      # --------------------------------------
      - name: Install SQLMap
        run: sudo apt install -y sqlmap

      - name: Run SQLMap (safe mode)
        run: |
          sqlmap -u "${{ env.TARGET_URL }}" \
            --batch --crawl=2 --level=2 --risk=1 \
            --dbs --forms --output-dir=sqlmap_output
        continue-on-error: true

      # --------------------------------------
      # Upload artifacts
      # --------------------------------------
      - name: Upload DAST reports
        uses: actions/upload-artifact@v4
        with:
          name: dast-reports
          path: |
            /tmp/zap
            wapiti-report.html
            sqlmap_output/**

name: DAST Security Scans

on:
  workflow_dispatch:
    inputs:
      target_url:
        description: "Target URL to scan"
        required: true
        default: "https://trash-tracker-alb-app-820015371.eu-central-1.elb.amazonaws.com/"

jobs:
  dast-scans:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # --------------------------------------
      # OWASP ZAP
      # --------------------------------------
      - name: Run OWASP ZAP Baseline Scan
        uses: zaproxy/action-baseline@v0.12.0
        with:
          target: ${{ github.event.inputs.target_url }}
          rules_file_name: ".zap-rules.txt"
          cmd_options: "-a"
        continue-on-error: true

      # --------------------------------------
      # WAPITI
      # --------------------------------------
      - name: Install Wapiti
        run: sudo apt update && sudo apt install -y wapiti

      - name: Run Wapiti scan
        run: |
          wapiti -u "${{ github.event.inputs.target_url }}" -f html -o wapiti-report.html
        continue-on-error: true

      # --------------------------------------
      # SQLMAP
      # --------------------------------------
      - name: Install SQLMap
        run: sudo apt install -y sqlmap

      - name: Run SQLMap (safe mode)
        run: |
          sqlmap -u "${{ github.event.inputs.target_url }}" \
            --batch --crawl=2 --level=2 --risk=1 \
            --dbs --forms --output-dir=sqlmap_output
        continue-on-error: true

      # --------------------------------------
      # BURP SUITE VIA REST API
      # --------------------------------------
      - name: Run Burp Scanner
        run: |
          docker run -d --name burp -p 1337:1337 vmware/burp-rest-api
          sleep 15
          curl -X POST "http://localhost:1337/v0.1/scan" \
              -H "Content-Type: application/json" \
              -d '{"url": "${{ github.event.inputs.target_url }}"}' \
              -o burp_result.json
        continue-on-error: true

      # --------------------------------------
      # Upload artifacts
      # --------------------------------------
      - name: Upload DAST reports
        uses: actions/upload-artifact@v4
        with:
          name: dast-reports
          path: |
            owasp-zap-report.html
            wapiti-report.html
            sqlmap_output/**
            burp_result.json

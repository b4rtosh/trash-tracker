name: Deploy to AWS

on:
  push:
    branches:
      - main
  workflow_dispatch:
    

env:
  AWS_REGION: eu-north-1
  ECR_REPOSITORY: trash-tracker/app
  TF_VAR_FILE: prod.tfvars

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v2
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}

    - name: Login to Amazon ECR
      id: login-ecr
      uses: aws-actions/amazon-ecr-login@v1

    - name: Build and push Docker image
      env:
        ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
        IMAGE_TAG: ${{ github.sha }}
      run: |
        docker build -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG ./src
        docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG
        docker tag $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG $ECR_REGISTRY/$ECR_REPOSITORY:latest
        docker push $ECR_REGISTRY/$ECR_REPOSITORY:latest

    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v2
      with:
        terraform_version: 1.5.0
        terraform_wrapper: false

    - name: Terraform Init
      working-directory: ./infra
      run: terraform init -backend-config="backend.hcl"


    - name: Validate Configuration
      working-directory: ./infra
      env:
        TF_VAR_domain_name: ${{ secrets.DOMAIN_NAME }}
      run: |
        if [ -z "$TF_VAR_domain_name" ]; then
          echo "ERROR: DOMAIN_NAME secret is not set"
          echo "Please add DOMAIN_NAME to GitHub repository secrets"
          exit 1
        fi
        echo "Domain configured: $TF_VAR_domain_name"
        terraform validate

    - name: Terraform Plan
      working-directory: ./infra
      env:
        TF_VAR_app_container_image: ${{ steps.login-ecr.outputs.registry }}/${{ env.ECR_REPOSITORY }}:${{ github.sha }}
        TF_VAR_db_master_username: ${{ secrets.DB_MASTER_USERNAME }}
        TF_VAR_db_master_password: ${{ secrets.DB_MASTER_PASSWORD }}
        TF_VAR_domain_name: ${{ secrets.DOMAIN_NAME }}
      run: terraform plan -var-file=${{ env.TF_VAR_FILE }}

    - name: Terraform Apply
      working-directory: ./infra
      env:
        TF_VAR_app_container_image: ${{ steps.login-ecr.outputs.registry }}/${{ env.ECR_REPOSITORY }}:${{ github.sha }}
        TF_VAR_db_master_username: ${{ secrets.DB_MASTER_USERNAME }}
        TF_VAR_db_master_password: ${{ secrets.DB_MASTER_PASSWORD }}
        TF_VAR_domain_name: ${{ secrets.DOMAIN_NAME }}
      run: terraform apply -auto-approve -var-file=${{ env.TF_VAR_FILE }}

    - name: Get Terraform Outputs
      id: tf-outputs
      working-directory: ./infra
      run: |
        echo "cluster_name=$(terraform output -raw ecs_cluster_name)" >> $GITHUB_OUTPUT
        echo "migration_task=$(terraform output -raw migration_task_family)" >> $GITHUB_OUTPUT
        echo "subnets=$(terraform output -json private_subnets | jq -r 'join(",")')" >> $GITHUB_OUTPUT
        echo "security_group=$(terraform output -raw app_security_group_id)" >> $GITHUB_OUTPUT
        echo "alb_dns=$(terraform output -raw alb_dns_name)" >> $GITHUB_OUTPUT

    - name: Display Cloudflare Configuration
      env:
        ALB_DNS: ${{ steps.tf-outputs.outputs.alb_dns }}
        DOMAIN: ${{ secrets.DOMAIN_NAME }}
      run: |
        echo "=========================================="
        echo "ðŸ“‹ Cloudflare Configuration Instructions"
        echo "=========================================="
        echo ""
        echo "1. Go to Cloudflare Dashboard â†’ DNS"
        echo "2. Add/Update A or CNAME record:"
        echo "   - Type: CNAME"
        echo "   - Name: @ (or subdomain)"
        echo "   - Target: $ALB_DNS"
        echo "   - Proxy status: Proxied (orange cloud)"
        echo ""
        echo "3. Go to SSL/TLS â†’ Overview"
        echo "   - Set mode to: Full"
        echo ""
        echo "4. Recommended settings:"
        echo "   - Always Use HTTPS: ON"
        echo "   - Minimum TLS Version: 1.2"
        echo "   - TLS 1.3: ON"
        echo ""
        echo "Your site will be available at: https://$DOMAIN"
        echo "=========================================="

    - name: Run Database Migrations
      env:
        CLUSTER_NAME: ${{ steps.tf-outputs.outputs.cluster_name }}
        TASK_FAMILY: ${{ steps.tf-outputs.outputs.migration_task }}
        SUBNETS: ${{ steps.tf-outputs.outputs.subnets }}
        SECURITY_GROUP: ${{ steps.tf-outputs.outputs.security_group }}
      run: |
        echo "Running migrations on cluster: $CLUSTER_NAME"
        
        # Run the migration task
        TASK_ARN=$(aws ecs run-task \
          --cluster $CLUSTER_NAME \
          --task-definition $TASK_FAMILY \
          --launch-type FARGATE \
          --network-configuration "awsvpcConfiguration={subnets=[$SUBNETS],securityGroups=[$SECURITY_GROUP],assignPublicIp=DISABLED}" \
          --region ${{ env.AWS_REGION }} \
          --query 'tasks[0].taskArn' \
          --output text)
        
        if [ -z "$TASK_ARN" ] || [ "$TASK_ARN" == "None" ]; then
          echo "Failed to start migration task"
          exit 1
        fi
        
        echo "Migration task started: $TASK_ARN"
        
        # Wait for task to complete
        echo "Waiting for migration task to complete..."
        aws ecs wait tasks-stopped \
          --cluster $CLUSTER_NAME \
          --tasks $TASK_ARN \
          --region ${{ env.AWS_REGION }}
        
        # Check if migration was successful
        EXIT_CODE=$(aws ecs describe-tasks \
          --cluster $CLUSTER_NAME \
          --tasks $TASK_ARN \
          --region ${{ env.AWS_REGION }} \
          --query 'tasks[0].containers[0].exitCode' \
          --output text)
        
        echo "Migration task exit code: $EXIT_CODE"
        
        if [ "$EXIT_CODE" != "0" ]; then
          echo "Migration failed with exit code: $EXIT_CODE"
          echo "Fetching logs..."
          
          # Get log stream name
          LOG_STREAM=$(aws ecs describe-tasks \
            --cluster $CLUSTER_NAME \
            --tasks $TASK_ARN \
            --region ${{ env.AWS_REGION }} \
            --query 'tasks[0].containers[0].name' \
            --output text)
          
          # Show last 50 log lines
          aws logs tail /ecs/migrations --follow --since 5m || true
          
          exit 1
        fi
        
        echo "Migrations completed successfully"

    - name: Update ECS Service
      env:
        CLUSTER_NAME: ${{ steps.tf-outputs.outputs.cluster_name }}
      run: |
        echo "Updating ECS service with new task definition..."
        aws ecs update-service \
          --cluster $CLUSTER_NAME \
          --service trash-tracker-app-service \
          --force-new-deployment \
          --region ${{ env.AWS_REGION }}
        
        echo "Service update initiated"
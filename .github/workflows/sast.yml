name: SAST Scan PR

on:
  pull_request:
    branches: [ "sast-scan-feature" ]
  push:
    branches: [ "sast-scan-feature" ]

jobs:
  sast:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repo
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: "3.11"

    - name: Install dependencies
      run: |
        pip install --upgrade pip
        pip install -r requirements.txt || true

    # ---- SEMGREP ----
    - name: Semgrep Scan
      run: |
        pip install semgrep
        semgrep --config p/owasp-top-ten --json --output semgrep-report.json --include . || true
      continue-on-error: true

    # ---- BANDIT ----
    - name: Bandit Scan
      run: |
        pip install bandit
        bandit -r . -f json -o bandit-report.json || true
      continue-on-error: true

    # ---- CODEQL ----
    - name: Initialize CodeQL
      uses: github/codeql-action/init@v2
      with:
        languages: python

    - name: Autobuild
      uses: github/codeql-action/autobuild@v2

    - name: Run CodeQL Analysis (local SARIF only)
      run: |
        codeql database analyze codeql-database \
          --format=sarif-latest \
          --output=codeql-report.sarif

    # ---- Convert SARIF to JSON for local analysis ----
    - name: Convert CodeQL SARIF to JSON
      run: |
        pip install sarif-om
        python3 - <<EOF
        import json
        import sarif_om

        sarif_file = "codeql-report.sarif"
        json_out = "codeql-report.json"

        try:
            with open(sarif_file, "r") as f:
                sarif = sarif_om.SarifLog.from_dict(json.load(f))
            results = []
            for r in sarif.runs[0].results or []:
                results.append({
                    "ruleId": r.ruleId,
                    "severity": getattr(r.level, "name", str(r.level)).upper(),
                    "message": r.message.text
                })
            with open(json_out, "w") as f:
                json.dump({"results": results}, f)
        except Exception:
            with open(json_out, "w") as f:
                json.dump({"results": []}, f)
        EOF

    # ---- Upload artifacts ----
    - name: Upload SAST Reports
      uses: actions/upload-artifact@v4
      with:
        name: sast-reports
        path: |
          semgrep-report.json
          bandit-report.json
          codeql-report.json

    # ---- ANALYZE REPORTS FOR CRITICAL ISSUES ----
    - name: Check for Critical Issues
      id: check_reports
      run: |
        python3 <<EOF
        import json, sys

        critical = False

        # --- SEMGREP ---
        try:
            with open("semgrep-report.json") as f:
                sem = json.load(f)
        except:
            sem = {"results": []}
        for result in sem.get("results", []):
            if result.get("extra", {}).get("severity") == "ERROR":
                critical = True

        # --- BANDIT ---
        try:
            with open("bandit-report.json") as f:
                bandit = json.load(f)
        except:
            bandit = {"results": []}
        for r in bandit.get("results", []):
            if r.get("issue_severity") == "HIGH":
                critical = True

        # --- CODEQL ---
        try:
            with open("codeql-report.json") as f:
                codeql = json.load(f)
        except:
            codeql = {"results": []}
        for r in codeql.get("results", []):
            if r.get("severity", "").lower() in ["error", "critical", "high"]:
                critical = True

        # --- GENERATE ISSUE FILE ---
        with open("issue.md", "w") as f:
            if critical:
                f.write("Critical SAST issues detected. Check reports in artifacts.\n")
            else:
                f.write("No critical issues detected.\n")

        if critical:
            print("CRITICAL ISSUES DETECTED")
            sys.exit(1)
        else:
            print("No critical issues detected.")
        EOF

    # ---- CREATE GITHUB ISSUE WHEN CRITICAL FOUND ----
    - name: Create GitHub Issue
      if: failure()
      uses: peter-evans/create-issue-from-file@v6
      with:
        title: "Critical SAST Issues Detected"
        content-filepath: issue.md
        labels: security, urgent
